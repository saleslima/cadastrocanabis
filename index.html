<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Autorização para Cannabis Medicinal</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --bg-primary: #f5f5f5;
            --bg-container: #fff;
            --text-primary: #2c3e50;
            --text-secondary: #333;
            --border-color: #ddd;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-secondary: #95a5a6;
            --button-secondary-hover: #7f8c8d;
            --button-danger: #e74c3c;
            --button-danger-hover: #c0392b;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-container: #2c2c2c;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --border-color: #444;
            --button-primary: #2980b9;
            --button-primary-hover: #3498db;
            --button-secondary: #7f8c8d;
            --button-secondary-hover: #95a5a6;
            --button-danger: #c0392b;
            --button-danger-hover: #e74c3c;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--bg-primary);
            padding: 20px;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-container);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 100;
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background-color: var(--button-primary-hover);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: var(--bg-container);
            color: var(--text-primary);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }

        select {
            cursor: pointer;
        }

        button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--button-primary-hover);
        }

        .primary-btn {
            background-color: var(--button-primary);
        }

        .primary-btn:hover {
            background-color: var(--button-primary-hover);
        }

        .secondary-btn {
            background-color: var(--button-secondary);
        }

        .secondary-btn:hover {
            background-color: var(--button-secondary-hover);
        }

        .endereco-form {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            background-color: var(--bg-container);
            transition: border-color 0.3s, background-color 0.3s;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .half {
            flex: 0.5;
        }

        .third {
            flex: 0.33;
        }

        .two-thirds {
            flex: 0.67;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
        }

        .input-with-button button {
            padding: 12px 15px;
        }

        .success-message {
            color: var(--success-color);
            text-align: center;
            margin-top: 20px;
            font-weight: 600;
            display: none;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            margin-top: 20px;
            font-weight: 600;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 0;
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-buttons {
                flex-direction: column;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }

            .theme-toggle svg {
                width: 20px;
                height: 20px;
            }

            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 24px;
            }

            .container {
                padding: 10px;
            }

            input, select, button {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle" aria-label="Alternar modo escuro">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="moon-icon">
            <path d="M12 11.807A9.002 9.002 0 0 1 10.049 2a9.942 9.942 0 0 0-5.12 2.735c-3.905 3.905-3.905 10.237 0 14.142 3.906 3.906 10.237 3.905 14.143 0a9.946 9.946 0 0 0 2.735-5.119A9.003 9.003 0 0 1 12 11.807z"></path>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="sun-icon" style="display: none;">
            <path d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007-2.246-5.007-5.007-5.007S6.995 9.239 6.995 12zM11 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2H2zm17 0h3v2h-3zM5.637 19.778l-1.414-1.414 2.121-2.121 1.414 1.414zM16.242 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.344 7.759 4.223 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z"></path>
        </svg>
    </button>

    <div class="container">
        <h1>Formulário de Autorização para Cannabis Medicinal</h1>
        
        <form id="autorizacaoForm">
            <div class="form-group">
                <label for="nomePaciente">Nome do Paciente *</label>
                <input type="text" id="nomePaciente" name="nomePaciente" required>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label for="rg">RG do Paciente *</label>
                    <input type="text" id="rg" name="rg" placeholder="00.000.000-0" required>
                </div>
                <div class="form-group half">
                    <label for="cpf">CPF do Paciente *</label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                </div>
            </div>

            <div class="form-group">
                <label for="numProcesso">Nº do Processo *</label>
                <input type="text" id="numProcesso" name="numProcesso" required>
            </div>

            <div class="form-group">
                <label for="nomeMagistrado">Nome do Magistrado que Concedeu Autorização *</label>
                <input type="text" id="nomeMagistrado" name="nomeMagistrado" required>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label for="dataDecisao">Data da Decisão *</label>
                    <input type="date" id="dataDecisao" name="dataDecisao" required>
                </div>
                <div class="form-group half">
                    <label for="prazoValidade">Prazo de Validade *</label>
                    <input type="date" id="prazoValidade" name="prazoValidade" required>
                </div>
            </div>

            <div class="form-group">
                <label for="tipoAutorizacao">Tipo de Autorização *</label>
                <select id="tipoAutorizacao" name="tipoAutorizacao" required>
                    <option value="">Selecione uma opção</option>
                    <option value="porte">Porte</option>
                    <option value="transporte">Transporte</option>
                    <option value="cultivo">Cultivo</option>
                    <option value="importacao">Importação</option>
                    <option value="producao">Produção</option>
                    <option value="outro">Outro</option>
                </select>
                <input type="text" id="outroTipoAutorizacao" name="outroTipoAutorizacao" placeholder="Especifique o tipo" style="display: none;">
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label for="quantidadePlanta">Quantidade de Plantas</label>
                    <input type="number" id="quantidadePlanta" name="quantidadePlanta" min="0">
                </div>
                <div class="form-group half">
                    <label for="quantidadeSementes">Quantidade de Sementes</label>
                    <input type="number" id="quantidadeSementes" name="quantidadeSementes" min="0">
                </div>
            </div>

            <div class="form-group">
                <button type="button" id="enderecosBtn" class="secondary-btn">Endereços Autorizados</button>
            </div>

            <div id="enderecosContainer" style="display: none;">
                <div class="form-group">
                    <label for="qtdEnderecos">Quantidade de Endereços:</label>
                    <div class="input-with-button">
                        <input type="number" id="qtdEnderecos" min="1" value="1">
                        <button type="button" id="confirmarQtdBtn" class="secondary-btn">Confirmar</button>
                    </div>
                </div>
                <div id="enderecosForm">
                    <!-- Os formulários de endereço serão adicionados aqui dinamicamente -->
                </div>
            </div>

            <div class="form-buttons">
                <button type="submit" class="primary-btn">Enviar</button>
                <button type="reset" class="secondary-btn">Limpar</button>
            </div>
            
            <div class="success-message" id="successMessage">Autorização salva com sucesso!</div>
            <div class="error-message" id="errorMessage"></div>
        </form>
    </div>
    
    <!-- Template para endereço -->
    <template id="enderecoTemplate">
        <div class="endereco-form">
            <h3>Endereço #<span class="endereco-numero"></span></h3>
            <div class="form-row">
                <div class="form-group two-thirds">
                    <label for="cep">CEP *</label>
                    <div class="input-with-button">
                        <input type="text" class="cep-input" placeholder="00000-000" maxlength="9" required>
                        <button type="button" class="buscar-cep-btn secondary-btn">OK</button>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group two-thirds">
                    <label for="rua">Rua *</label>
                    <input type="text" class="rua-input" required readonly>
                </div>
                <div class="form-group third">
                    <label for="numero">Número *</label>
                    <input type="text" class="numero-input" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="bairro">Bairro *</label>
                    <input type="text" class="bairro-input" required readonly>
                </div>
                <div class="form-group half">
                    <label for="cidade">Cidade *</label>
                    <input type="text" class="cidade-input" required readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="estado">Estado *</label>
                    <input type="text" class="estado-input" required readonly>
                </div>
                <div class="form-group half">
                    <label for="tipoLocal">Tipo de Local *</label>
                    <input type="text" class="tipo-local-input" required>
                </div>
            </div>
        </div>
    </template>

    <!-- Importação do Firebase -->
    <script type="module">
        // Importar as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBtxISdCskCtUxDT-HW8vIqNf8ZsY6AWQA",
            authDomain: "prelecao-a973b.firebaseapp.com",
            databaseURL: "https://prelecao-a973b-default-rtdb.firebaseio.com",
            projectId: "prelecao-a973b",
            storageBucket: "prelecao-a973b.firebasestorage.app",
            messagingSenderId: "103686484883",
            appId: "1:103686484883:web:d3eeb0bc319d575967ae66"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Elementos DOM
        const form = document.getElementById('autorizacaoForm');
        const tipoAutorizacaoSelect = document.getElementById('tipoAutorizacao');
        const outroTipoInput = document.getElementById('outroTipoAutorizacao');
        const enderecosBtn = document.getElementById('enderecosBtn');
        const enderecosContainer = document.getElementById('enderecosContainer');
        const qtdEnderecosInput = document.getElementById('qtdEnderecos');
        const confirmarQtdBtn = document.getElementById('confirmarQtdBtn');
        const enderecosForm = document.getElementById('enderecosForm');
        const enderecoTemplate = document.getElementById('enderecoTemplate');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const themeToggle = document.getElementById('themeToggle');
        const moonIcon = themeToggle.querySelector('.moon-icon');
        const sunIcon = themeToggle.querySelector('.sun-icon');
        
        // Array para armazenar os endereços
        let enderecos = [];
        
        // Verificar preferência do usuário no localStorage
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            moonIcon.style.display = 'none';
            sunIcon.style.display = 'block';
        }
        
        // Toggle para modo escuro
        themeToggle.addEventListener('click', function() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
            }
        });
        
        // Mostrar/ocultar campo para tipo de autorização personalizado
        tipoAutorizacaoSelect.addEventListener('change', function() {
            if (this.value === 'outro') {
                outroTipoInput.style.display = 'block';
                outroTipoInput.required = true;
            } else {
                outroTipoInput.style.display = 'none';
                outroTipoInput.required = false;
            }
        });
        
        // Mostrar/ocultar seção de endereços
        enderecosBtn.addEventListener('click', function() {
            enderecosContainer.style.display = enderecosContainer.style.display === 'none' ? 'block' : 'none';
        });
        
        // Função para formatar CPF
        document.getElementById('cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})/, '$1.$2.$3-');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})/, '$1.$2.');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})/, '$1.');
            }
            e.target.value = value;
        });
        
        // Função para formatar RG
        document.getElementById('rg').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 9) value = value.substring(0, 9);
            if (value.length > 7) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})/, '$1.$2.$3-');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})/, '$1.$2.');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})/, '$1.');
            }
            e.target.value = value;
        });
        
        // Gerar formulários de endereço com base na quantidade informada
        confirmarQtdBtn.addEventListener('click', function() {
            const quantidade = parseInt(qtdEnderecosInput.value);
            if (quantidade <= 0) {
                alert('A quantidade deve ser maior que zero');
                return;
            }
            
            // Limpar formulários existentes
            enderecosForm.innerHTML = '';
            enderecos = [];
            
            // Criar novos formulários
            for (let i = 1; i <= quantidade; i++) {
                criarFormularioEndereco(i);
            }
        });
        
        // Função para criar um formulário de endereço
        function criarFormularioEndereco(numero) {
            const clone = document.importNode(enderecoTemplate.content, true);
            clone.querySelector('.endereco-numero').textContent = numero;
            
            // Configurar event listeners
            const cepInput = clone.querySelector('.cep-input');
            const buscarCepBtn = clone.querySelector('.buscar-cep-btn');
            
            // Formatar CEP
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) value = value.substring(0, 8);
                if (value.length > 5) {
                    value = value.replace(/^(\d{5})(\d{3})/, '$1-$2');
                }
                e.target.value = value;
            });
            
            // Buscar CEP
            buscarCepBtn.addEventListener('click', function() {
                const cep = cepInput.value.replace(/\D/g, '');
                
                if (cep.length !== 8) {
                    alert('CEP inválido');
                    return;
                }
                
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.erro) {
                            alert('CEP não encontrado');
                            return;
                        }
                        
                        const parent = this.closest('.endereco-form');
                        parent.querySelector('.rua-input').value = data.logradouro;
                        parent.querySelector('.bairro-input').value = data.bairro;
                        parent.querySelector('.cidade-input').value = data.localidade;
                        parent.querySelector('.estado-input').value = data.uf;
                    })
                    .catch(error => {
                        console.error('Erro ao buscar CEP:', error);
                        alert('Erro ao buscar CEP. Tente novamente.');
                    });
            });
            
            enderecosForm.appendChild(clone);
        }
        
        // Enviar formulário
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Verificar se há endereços preenchidos quando a seção está visível
            if (enderecosContainer.style.display !== 'none') {
                const formularios = enderecosForm.querySelectorAll('.endereco-form');
                
                if (formularios.length === 0) {
                    errorMessage.textContent = 'Adicione pelo menos um endereço';
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none';
                    return;
                }
                
                // Validar e coletar dados dos endereços
                enderecos = [];
                let enderecoInvalido = false;
                
                formularios.forEach((form, index) => {
                    const cep = form.querySelector('.cep-input').value;
                    const rua = form.querySelector('.rua-input').value;
                    const numero = form.querySelector('.numero-input').value;
                    const bairro = form.querySelector('.bairro-input').value;
                    const cidade = form.querySelector('.cidade-input').value;
                    const estado = form.querySelector('.estado-input').value;
                    const tipoLocal = form.querySelector('.tipo-local-input').value;
                    
                    if (!cep || !rua || !numero || !bairro || !cidade || !estado || !tipoLocal) {
                        enderecoInvalido = true;
                        return;
                    }
                    
                    enderecos.push({
                        cep,
                        rua,
                        numero,
                        bairro,
                        cidade,
                        estado,
                        tipoLocal
                    });
                });
                
                if (enderecoInvalido) {
                    errorMessage.textContent = 'Preencha todos os campos de endereço';
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none';
                    return;
                }
            }
            
            // Coletar dados do formulário
            const formData = {
                nomePaciente: document.getElementById('nomePaciente').value,
                rgPaciente: document.getElementById('rg').value,
                cpfPaciente: document.getElementById('cpf').value,
                numeroProcesso: document.getElementById('numProcesso').value,
                nomeMagistrado: document.getElementById('nomeMagistrado').value,
                dataDecisao: document.getElementById('dataDecisao').value,
                prazoValidade: document.getElementById('prazoValidade').value,
                tipoAutorizacao: document.getElementById('tipoAutorizacao').value,
                outroTipoAutorizacao: document.getElementById('tipoAutorizacao').value === 'outro' ? 
                                    document.getElementById('outroTipoAutorizacao').value : '',
                quantidadePlanta: document.getElementById('quantidadePlanta').value,
                quantidadeSementes: document.getElementById('quantidadeSementes').value,
                enderecos: enderecos,
                dataCadastro: new Date().toISOString()
            };
            
            // Referência para o nó 'autorizacoes' no banco de dados
            const autorizacoesRef = ref(database, 'autorizacoes');
            
            // Salvar no Firebase
            push(autorizacoesRef, formData)
                .then(() => {
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none';
                    
                    // Limpar formulário
                    form.reset();
                    enderecosForm.innerHTML = '';
                    enderecosContainer.style.display = 'none';
                    enderecos = [];
                    
                    // Esconder mensagem de sucesso após 3 segundos
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Erro ao salvar:', error);
                    errorMessage.textContent = 'Erro ao salvar autorização. Tente novamente.';
                    errorMessage.style.display = 'block';
                    successMessage.style.display = 'none';
                });
        });
    </script>
</body>
</html>